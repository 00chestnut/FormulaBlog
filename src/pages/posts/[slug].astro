---
// src/pages/posts/[slug].astro
import "../../styles/global.css";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";

// Get the slug from the URL parameters
const { slug } = Astro.params;

// Fetch the specific post based on the slug
async function getPostBySlug(slug) {
  try {
    const response = await fetch(`https://your-wordpress-site.com/wp-json/wp/v2/posts?slug=${slug}&_embed`);
    
    if (!response.ok) {
      throw new Error(`Error fetching post: ${response.status}`);
    }
    
    const posts = await response.json();
    
    // WordPress returns an array even when querying by slug (which should be unique)
    if (posts.length === 0) {
      return null;
    }
    
    const post = posts[0];
    
    // Get the featured image URL or fallback to a placeholder
    const featuredImageUrl = post._embedded?.['wp:featuredmedia']?.[0]?.source_url || 
                             "https://placehold.co/800x400?text=Image+Unavailable";
    
    return {
      id: post.id,
      title: post.title.rendered,
      content: post.content.rendered,
      imageUrl: featuredImageUrl,
      date: new Date(post.date).toLocaleDateString()
    };
  } catch (error) {
    console.error(`Failed to fetch post with slug ${slug}:`, error);
    return null;
  }
}

const post = await getPostBySlug(slug);

// Handle 404 if post not found
if (!post) {
  return Astro.redirect('/404');
}
---

<html>
  <head>
    <link rel="icon" type="image/svg+xml" href="/f1.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{post.title} - OnBoard Formula 1</title>
  </head>
  <body>
    <container>
      <Header />
      <main class="max-w-4xl mx-auto px-4 py-8">
        <article class="bg-white rounded-lg shadow-md overflow-hidden">
          <img 
            src={post.imageUrl} 
            alt={post.title}
            class="w-full h-64 object-cover"
          />
          
          <div class="p-6">
            <h1 class="text-3xl font-bold mb-2">{post.title}</h1>
            <div class="text-gray-500 mb-4">Published on {post.date}</div>
            
            <div class="prose max-w-none" set:html={post.content}></div>
          </div>
        </article>
      </main>
      <Footer />
    </container>
  </body>
</html>