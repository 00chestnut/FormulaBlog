---
// src/pages/page/[page].astro
import "../../styles/global.css";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import Card2 from "../../components/Card2.astro";
import Cage from "../../components/Cage.astro";
import SearchBar from "../../components/SearchBar.astro";
import Filters from "../../components/Filters.astro"
import { fetchPosts } from "../../scripts/scripts.js";

export async function getStaticPaths() {
  const allPosts = await fetchPosts();
  const postsPerPage = 3; // posts per page limiter
  const totalPages = Math.ceil(allPosts.length / postsPerPage);

  // Create an array of page numbers starting from 2 (not 1)
  const pages = Array.from({ length: totalPages - 1 }, (_, i) => i + 2);

  // Return the paths for all pages except page 1
  return pages.map((page) => {
    // Ensure correct slicing of posts per page
    const start = (page - 1) * postsPerPage;
    const end = start + postsPerPage;
    const pagePosts = allPosts.slice(start, end);

    return {
      params: { page: page.toString() },
      props: {
        posts: pagePosts,
        currentPage: page,
        totalPages,
        hasNextPage: page < totalPages,
        hasPrevPage: page > 1,
      },
    };
  });
}

const { posts, currentPage, totalPages, hasNextPage, hasPrevPage } =
  Astro.props;
---

<html lang="en">
  <head>
    <link rel="icon" type="image/svg+xml" href="/f1.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8" />
    <meta
      name="description"
      content={`OnBoard - The latest news, insights and stories about Formula 1 racing. Page ${currentPage} of ${totalPages}.`}
    />
    <meta
      name="keywords"
      content="Formula 1, Blog, F1, OnBoard, Racing, Motorsport"
    />
    <meta name="author" content="00chestnut" />
    <meta name="robots" content="index, follow" />
    <meta
      property="og:title"
      content={`OnBoard - Formula 1 - Page ${currentPage}`}
    />
    <meta
      property="og:description"
      content={`The latest news, insights and stories about Formula 1 racing. Page ${currentPage} of ${totalPages}.`}
    />
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content={`https://your-website.com/page/${currentPage}`}
    />
    <link
      rel="canonical"
      href={`https://your-website.com/page/${currentPage}`}
    />
    {hasPrevPage && <link rel="prev" href={`/page/${currentPage - 1}`} />}
    {hasNextPage && <link rel="next" href={`/page/${currentPage + 1}`} />}
    <title>OnBoard - Formula 1 - Page {currentPage}</title>
  </head>
  <body class="transition-colors duration-300 ease-in-out">
    <container>
      <Header />
      <main class="flex flex-col flex-grow min-h-screen">
        <Cage>
          <Filters />
          <div class="w-full mb-12">
            <SearchBar />
          </div>
          {  
            posts.length > 0 ? (
            // @ts-ignore
              posts.map((post) => (
                <Card2
                  picture={post.imageUrl}
                  alt={post.title}
                  name={post.title}
                  desc={post.description}
                  btn="Read more"
                  slug={post.slug}
                />
              ))
            ) : (
              <div class="text-center p-8 bg-white-200 border border-gray-200 rounded-lg shadow-sm dark:bg-gray-800 dark:border-gray-700">
                <h3 class="text-xl font-bold dark:text-white">No posts found - big problem</h3>
                <br />
                <p class="dark:text-gray-300">
                  Please{" "}
                  <a href="../../footerpages/contact" class="text-blue-500 bold hover:underline">
                    contact
                  </a>{" "}
                  the site developer as soon as possible.
                </p>
                <br />
                <br />
                <div class="flex justify-center items-center">
                  <img src="/images/shark.png" class="w-[15rem] h-[15rem] object-center" alt="Error shark" />
                </div>
              </div>
            )
          }
        </Cage>
      
        <!-- Wrapper to push pagination to the bottom -->
        <div class="flex-grow"></div> 
      
        <div class="pagination-container py-4">
          <div class="pagination flex justify-center items-center my-4 gap-2 px-4">
            <a href="../" class={`px-3 py-2 rounded-lg ${hasPrevPage ? "bg-red-700 text-white hover:bg-red-800" : "bg-gray-300 text-gray-500 cursor-not-allowed"}`} aria-disabled={!hasPrevPage}>&lt;&lt;</a>
      
            <a href={currentPage === 2 ? "../" : `/page/${currentPage - 1}`} class={`px-3 py-2 rounded-lg ${hasPrevPage ? "bg-red-700 text-white hover:bg-red-800" : "bg-gray-300 text-gray-500 cursor-not-allowed"}`} aria-disabled={!hasPrevPage}>&lt;</a>
      
            <span class="PageNumber px-3 py-2 font-medium dark:text-white">
              Page {currentPage} of {totalPages}
            </span>
      
            <a href={hasNextPage ? `/page/${currentPage + 1}` : "#"} class={`px-3 py-2 rounded-lg ${hasNextPage ? "bg-red-700 text-white hover:bg-red-800" : "bg-gray-300 text-gray-500 cursor-not-allowed"}`} aria-disabled={!hasNextPage}>&gt;</a>
      
            <a href={`/page/${totalPages}`} class={`px-3 py-2 rounded-lg ${hasNextPage ? "bg-red-700 text-white hover:bg-red-800" : "bg-gray-300 text-gray-500 cursor-not-allowed"}`} aria-disabled={!hasNextPage}>&gt;&gt;</a>
          </div>
        </div>
      </main>
      
      </main>
      <Footer />
    </container>
    
    <style is:global>
      * {
        transition-property: background-color, border-color, color, fill, stroke;
        transition-duration: 300ms;
        transition-timing-function: ease-in-out;
      }
    </style>
  </body>
</html>